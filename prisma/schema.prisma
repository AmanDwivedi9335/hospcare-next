// Prisma schema for the HospCare SaaS platform

generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPERADMIN
  HOSPITAL_ADMIN
  STAFF
}

enum StaffRole {
  DOCTOR
  NURSE
  ACCOUNTANT
  LAB_TECH
  PHARMACIST
  OTHER
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Tenant {
  id           String         @id @default(cuid())
  name         String
  slug         String         @unique
  contactEmail String
  contactPhone String?
  address      Json?
  subscription Subscription?
  modules      TenantModule[]
  users        User[]
  facilities   Facility[]
  departments  Department[]
  staff        StaffProfile[]
  patients     Patient[]
  appointments Appointment[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Facility {
  id            String         @id @default(cuid())
  tenantId      String
  name          String
  code          String         @unique
  contactNumber String?
  address       Json?
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departments   Department[]
  staff         StaffProfile[]
  patients      Patient[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([tenantId])
}

model Module {
  id               Int            @id @default(autoincrement())
  name             String
  code             String         @unique
  description      String?
  category         String?
  baseMonthlyPrice Decimal        @default(0) @db.Decimal(10, 2)
  isCore           Boolean        @default(false)
  tenantModules    TenantModule[]
  planModules      PlanModule[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model Plan {
  id            Int            @id @default(autoincrement())
  name          String
  slug          String         @unique
  description   String?
  billingCycle  BillingCycle   @default(MONTHLY)
  price         Decimal        @db.Decimal(10, 2)
  currency      String         @default("INR")
  planModules   PlanModule[]
  subscriptions Subscription[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model PlanModule {
  planId   Int
  moduleId Int
  included Boolean @default(true)
  plan     Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  module   Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@id([planId, moduleId])
}

model TenantModule {
  tenantId           String
  moduleId           Int
  isActive           Boolean  @default(true)
  customMonthlyPrice Decimal? @db.Decimal(10, 2)
  activatedAt        DateTime @default(now())
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  module             Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@id([tenantId, moduleId])
}

model Subscription {
  id                 String                @id @default(cuid())
  tenantId           String                @unique
  planId             Int
  status             SubscriptionStatus    @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEndsAt        DateTime?
  meta               Json?
  tenant             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan               Plan                  @relation(fields: [planId], references: [id])
  invoices           SubscriptionInvoice[]
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
}

model SubscriptionInvoice {
  id             String       @id @default(cuid())
  subscriptionId String
  amount         Decimal      @db.Decimal(10, 2)
  currency       String       @default("INR")
  dueDate        DateTime
  paid           Boolean      @default(false)
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([subscriptionId])
}

model User {
  id           String        @id @default(cuid())
  tenantId     String?
  email        String        @unique
  passwordHash String
  role         UserRole      @default(HOSPITAL_ADMIN)
  isActive     Boolean       @default(true)
  tenant       Tenant?       @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  staffProfile StaffProfile?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
}

model StaffProfile {
  id           String        @id @default(cuid())
  userId       String        @unique
  tenantId     String
  facilityId   String?
  departmentId Int?
  role         StaffRole     @default(OTHER)
  designation  String?
  phone        String?
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  facility     Facility?     @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  department   Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments Appointment[] @relation("StaffAppointments")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([tenantId])
  @@index([facilityId])
}

model Department {
  id          Int            @id @default(autoincrement())
  tenantId    String
  facilityId  String?
  name        String
  description String?
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  facility    Facility?      @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  staff       StaffProfile[]
  patients    Patient[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([tenantId])
  @@index([facilityId])
}

model Patient {
  id                  String        @id @default(cuid())
  tenantId            String
  facilityId          String?
  departmentId        Int?
  firstName           String
  lastName            String
  dateOfBirth         DateTime?
  gender              String?
  contactEmail        String?
  contactPhone        String?
  medicalRecordNumber String        @unique @default(uuid())
  tenant              Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  facility            Facility?     @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  department          Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  appointments        Appointment[] @relation("PatientAppointments")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([tenantId])
}

model Appointment {
  id          String            @id @default(cuid())
  tenantId    String
  patientId   String
  staffId     String
  scheduledAt DateTime
  status      AppointmentStatus @default(SCHEDULED)
  reason      String?
  notes       String?
  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient     Patient           @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  staff       StaffProfile      @relation("StaffAppointments", fields: [staffId], references: [id], onDelete: Cascade)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([tenantId])
  @@index([patientId])
  @@index([staffId])
}
